# I/O 设备

- [I/O 设备](#io-设备)
  - [标准I/O设备](#标准io设备)
  - [设备控制器与驱动](#设备控制器与驱动)
  - [轮询](#轮询)
  - [中断](#中断)
  - [DMA](#dma)
  - [总线](#总线)
  - [I/O复用](#io复用)
  - [参考](#参考)

I/O设备（Input/Output Device）即输入/输出设备，指的是可以与计算机交互的硬件设备。常见的I/O设备有：网卡、硬盘、键盘、鼠标、打印机等。一般来说，I/O设备可以分成字符设备（Character Device）、块设备（Block Device）和网络设备（Network Device）。其中，字符设备一般用于人机交互，比如：键盘、打印机、鼠标等。它们大多是以字符为单位发送和接收数据的。而块设备，一般用于持久化存储，比如：传统硬盘、固态硬盘、USB存储器等。它们大多是以块为单位进行传输的。

## 标准I/O设备

我们现在来看一个抽象概念的I/O设备，来帮助我们理解其架构和交互机制。

![图1 标准I/O设备](../img/operating_system_io_device.png)

由上图可知，它往往包含两部分组成。第一部分是向上暴露的硬件接口（Hardware Interface），允许上层应用通过该接口来控制它的操作；第二部分是它的内部结构（Internal Structure），负责实现接口展示的功能。它的内部结构通常包含简单的主控芯片、一些通用内存、设备相关的特定芯片以及它ROM上的固件（Firmware），以实现其功能。

此外，硬件接口往往可以抽象和简化成三类寄存器：一个状态寄存器（Status Register），可以读取并查看设备的当前状态；一个命令寄存器（Command Register），用于通知设备执行某个具体任务；一个数据寄存器（Data Register），将数据传给设备或从设备接收数据。通过读写这些寄存器，系统可以控制设备的行为。

## 设备控制器与驱动

在真实的计算机系统中，设备控制器（Device Controller）承担了图1中硬件接口的职能，它们为操作系统屏蔽了设备之间的差异。尽管如此，但每种设备的控制器的寄存器、缓冲区等使用模式都是不同的，所以为了屏蔽设备控制器的差异，工程师们引入了设备驱动程序（Device Driver）。

值得注意的是，设备控制器不属于操作系统范畴，它是属于硬件，而设备驱动程序属于操作系统的一部分，操作系统的内核代码可以像本地调用代码一样使用设备驱动程序的接口，而设备驱动程序是面向设备控制器的代码，它发出操控设备控制器的指令后，才可以操作设备控制器。

![图2 设备控制器与设备驱动](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F.png)

## 轮询

轮询（Polling）是一种系统与I/O设备交互机制。它描述的是一种系统反复访问设备，来第一时间得到设备就绪信息的机制。

**轮询的流程**：

- 首先，操作系统通过反复读取图1中设备的状态寄存器，等待设备进入可以接收命令的就绪状态。
- 其次，操作系统下发数据到数据寄存器。例如，你可以想象如果这是一个磁盘，可能需要多次写入操作，将一个磁盘块传递给设备。如果主CPU参与数据移动，我们就称之为编程的I/O（Programmed I/O，PIO）。
- 接着，操作系统将命令写入命令寄存器；这样设备就知道数据已经准备好了，它应该开始执行命令。
- 最后，操作系统再次通过不断轮询设备，等待并判断设备是否执行完成命令，得到一个指示成功或失败的错误码。

## 中断

尽管轮询已经足够应付一些简单的I/O操作，但它会使CPU占有率过高。因此，工程师们提出了一种新机制——中断（Interrupt）来减少CPU开销。

**中断分类**：

一般来说，中断可以分为硬中断和软中断。其中，前者通常与外部事件相关并由硬件或外设产生，比如：时钟中断、I/O设备中断；而后者则是依靠CPU指令产生，比如：Intel CPU定义int等指令。实际上，系统调用就是使用软中断切换到内核态，进而执行相关操作的。

**信号和软中断**：

信号（Signal）作为进程间通信（InterProcess Communication，IPC）的方式之一，它也常常被当作是一种对中断的软件模拟。那么信号和软中断的关系是什么呢？它是否是依靠中断实现的呢？

答案是，信号只是工作方式与中断类似，即都达成了异步通知的作用。此外，信号也不一定依赖中断实现，可能某些硬件平台使用了中断，有的没有。

> [知乎 软中断和信号是什么关系？](https://www.zhihu.com/question/33822078)

**中断的处理流程**：

有了中断后，CPU不再需要不断轮询设备，而是向设备发出一个请求，然后就可以让对应进程睡眠，切换执行其他任务。当设备完成了自身操作，会抛出一个硬件中断，引发CPU跳转执行操作系统预先定义好的中断处理程序（Interrupt Handler）。

![图3 中断处理流程](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/%E4%B8%AD%E6%96%AD%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B.png)

> 中断处理程序是一小段操作系统代码，它会结束之前的请求并且唤醒等待I/O的进程继续执行。

值得注意的是，设备驱动程序初始化的时候，要先注册一个该设备的中断处理函数。

**中断的局限**：

尽管中断处理慢速的I/O请求有着巨大优势，但并非所有场景都时候适合使用中断处理I/O请求。比如，一个处理网络请求的服务器可能因为写入或读取每一个包中数据都发送中断，而无法处理用户的其他请求。

## DMA

直接存取（Direct Memory Access）是一种可以协调完成内存和设备之间数据传输的设备，它是针对CPU参与IO的另一种改进方式。换句话说，DMA承担原本CPU的I/O职责，释放了CPU的控制权。

为了能够将数据传送给设备，操作系统会通过编程告诉DMA数据在内存的位置，要拷贝的大小以及要拷贝到哪个设备。在此之后，操作系统就可以处理其他请求了。当DMA的任务完成后，DMA 控制器会抛出一个中断来告诉操作系统自己已经完成数据传输。

## 总线

总线（Bus）是指计算机组件间规范化的交换数据的方式，即以一种通用的方式为各组件提供数据传送和控制逻辑。

**分类**：

- 数据总线（Data Bus）：在CPU与RAM之间来回传送需要处理或是需要储存的数据。
- 地址总线（Address Bus）：用来指定在RAM（Random Access Memory）之中储存的数据的地址。
- 控制总线（Control Bus）：将微处理器控制单元（Control Unit）的信号，传送到周边设备，一般常见的为USB Bus和1394 Bus。
- 扩展总线（Expansion Bus）：可连接扩展槽和电脑。
- 局部总线（Local Bus）：取代更高速数据传输的扩展总线。

**外部总线**：

外部总线，也叫I/O总线，指的就是用于连接CPU和外部I/O设备的总线。

## I/O复用

## 参考

- [Operating Systems: Three Easy Pieces: I/O Devices](https://pages.cs.wisc.edu/~remzi/OSTEP/Chinese/36.pdf)
- [小林Coding - 图解系统 - 设备管理](https://www.xiaolincoding.com/os/7_device/device.html)
