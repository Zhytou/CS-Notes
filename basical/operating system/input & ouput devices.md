# I/O 设备

- [I/O 设备](#io-设备)
  - [标准I/O设备](#标准io设备)
  - [总线](#总线)
  - [中断](#中断)
  - [DMA](#dma)
  - [交互](#交互)
  - [驱动](#驱动)
  - [参考](#参考)

I/O设备（Input/Output Device）即输入/输出设备，指的是可以与计算机交互的硬件设备。常见的I/O设备有：网卡、硬盘、键盘、鼠标、打印机等。一般来说，I/O设备可以分成字符设备（Character Device）、块设备（Block Device）和网络设备（Network Device）。其中，字符设备一般用于人机交互，比如：键盘、打印机、鼠标等。它们大多是以字符为单位发送和接收数据的。而块设备，一般用于持久化存储，比如：传统硬盘、固态硬盘、USB存储器等。它们大多是以块为单位进行传输的。

## 标准I/O设备

我们现在来看一个抽象概念的I/O设备，来帮助我们理解其架构和交互机制。

![标准I/O设备](../img/operating_system_io_device.png)

**整体结构**：

由上图可知，它往往包含两部分组成。第一部分是向上暴露的硬件接口（Hardware Interface），允许上层应用通过该接口来控制它的操作；第二部分是它的内部结构（Internal Structure），负责实现接口展示的功能。它的内部结构通常包含简单的主控芯片、一些通用内存、设备相关的特定芯片以及它ROM上的固件（Firmware），以实现其功能。

**交互机制**：

一种最简单的交互机制如下：

- 首先，操作系统通过反复读取状态寄存器，等待设备进入可以接收命令的就绪状态。我们称之为轮询（Polling）设备。
- 其次，操作系统下发数据到数据寄存器。例如，你可以想象如果这是一个磁盘，可能需要多次写入操作，将一个磁盘块传递给设备。如果主CPU参与数据移动，我们就称之为编程的I/O（Programmed I/O，PIO）。
- 接着，操作系统将命令写入命令寄存器；这样设备就知道数据已经准备好了，它应该开始执行命令。
- 最后，操作系统再次通过不断轮询设备，等待并判断设备是否执行完成命令，得到一个指示成功或失败的错误码。

## 总线

## 中断

多年前，工程师们发明了我们目前已经很常见的中断（Interrupt）来减少CPU开销。有了中断后，CPU 不再需要不断轮询设备，而是向设备发出一个请求，然后就可以让对应进程睡眠，切换执行其他任务。当设备完成了自身操作，会抛出一个硬件中断，引发CPU跳转执行操作系统预先定义好的中断服务例程（Interrupt Service Routine，ISR），或更为简单
的中断处理程序（Interrupt Handler）。中断处理程序是一小段操作系统代码，它会结束之前的请求（比如从设备读取到了数据或者错误码）并且唤醒等待 I/O 的进程继续执行。

尽管中断处理慢速的I/O请求有巨大优势，但并非所有场景都时候适合使用中断处理I/O请求。比如，一个处理网络请求的服务器可能因为写入或读取每一个包中数据都发送中断，而无法处理用户的其他请求。

## DMA

直接存取（Direct Memory Access）是一种可以协调完成内存和设备之间数据传输的设备，它是针对CPU参与IO另一种改进方式。换句话说，DMA承担原本CPU的I/O职责，释放了CPU的控制权。

为了能够将数据传送给设备，操作系统会通过编程告诉DMA数据在内存的位置，要拷贝的大小以及要拷贝到哪个设备。在此之后，操作系统就可以处理其他请求了。当DMA的任务完成后，DMA 控制器会抛出一个中断来告诉操作系统自己已经完成数据传输。

## 交互

## 驱动

![驱动在操作系统中的位置](../img/operating_system_drive_architecture.png)

## 参考

- [Operating Systems: Three Easy Pieces: I/O Devices](https://pages.cs.wisc.edu/~remzi/OSTEP/Chinese/36.pdf)
