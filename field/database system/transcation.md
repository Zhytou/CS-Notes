# 数据库事务

- [数据库事务](#数据库事务)
  - [事务模型](#事务模型)
    - [ACID](#acid)
    - [BASE](#base)
  - [并发与隔离](#并发与隔离)
    - [并发问题](#并发问题)
    - [并发控制](#并发控制)
    - [隔离级别](#隔离级别)

数据库事务是数据库运行中的逻辑工作单位，单个逻辑工作单元所执行的一系列操作，要么都执行，要么都不执行。

**事务状态**：

![事务状态](../img/database_transaction_state.png)

- 活动：初始状态；事务在执行时保持此状态
- 部分提交：在某些情况下，一个事务可能包含多个独立的操作，这些操作可以被分成多个阶段进行提交。
- 失败：发现无法继续正常执行后。
- 中止：事务回滚后，数据库恢复到事务开始前的状态。中止后有两个选项：
  - 重新启动事务：只有在没有内部逻辑错误的情况下才能完成
  - 终止事务：
- 已提交 – 成功完成后。

## 事务模型

ACID和BASE是两种不同的数据库事务模型，它们确定数据库组织和操作数据的方式。ACID数据库优先考虑一致性而不是可用性，如果事务中的任何步骤出现错误，整个事务都会失败。相比之下，BASE数据库优先考虑可用性而不是一致性。用户可以暂时访问不一致的数据，而不是让事务失败。数据一致性可以实现，但不能立即实现。

一般来说，关系型数据库往往遵从ACID特性，而分布式数据库则遵从BASE特性。

### ACID

**原子性 Atomicity**：事务的原子性指的是，事务中包含的程序作为数据库的逻辑工作单位，它所做的对数据修改操作要么全部执行，要么完全不执行。这种特性称为原子性。

**一致性 Consistency**：事务的一致性指的是在一个事务执行之前和执行之后数据库都必须处于一致性状态。这种特性称为事务的一致性。假如数据库的状态满足所有的完整性约束，就说该数据库是一致的。

**隔离性 Isolation**：分离性指并发的事务是相互隔离的。即一个事务内部的操作及正在操作的数据必须封锁起来，不被其它企图进行修改的事务看到。假如并发交叉执行的事务没有任何控制，操纵相同的共享对象的多个并发事务的执行可能引起异常情况。

**持久性 Durability**：持久性意味着当系统或介质发生故障时，确保已提交事务的更新不能丢失。即一旦一个事务提交，DBMS保证它对数据库中数据的改变应该是永久性的，即对已提交事务的更新能恢复。持久性通过数据库备份和恢复来保证。

> Atomicity, isolation, and durability are properties of the database, whereas consis‐ tency (in the ACID sense) is a property of the application. The application may rely on the database’s atomicity and isolation properties in order to achieve consistency, but it’s not up to the database alone. ---DDIA

值得一提的是，原子性，隔离性和持久性是数据库的属性，而一致性是应用程序的属性。以MySQL为例，它通过undo log保证原子性，通过lock和MVCC保证隔离性，通过redo log保证持久性，最终得到一致性。换句话说说AID是手段，C是目的！

### BASE

**基本可用性 Bascially Available**：系统在出现故障或异常情况时仍然能够保证基本的可用性，即使在部分功能受限的情况下。

**软状态 Soft State**：这意味着系统的状态可以随着时间而改变，即使没有输入。

**最终一致性 Eventual Consistency**：系统允许在不同节点之间存在短暂的数据不一致，但最终会达到一致状态。

## 并发与隔离

### 并发问题

在典型的应用程序中，多个事务并发运行。若不添加适当的并发控制，则往往会造成以下问题。

**脏读**：事务A读到了事务B未提交的数据。

**不可重复读**：事务A第一次查询得到一行记录row1，事务B提交修改后，事务A第二次查询得到row1，但列内容发生了变化。

**幻读**：事务A第一次查询得到一行记录row1，事务B提交修改后，事务A第二次查询得到两行记录row1和row2。

### 并发控制

**锁**：一种是在读取数据前，对其加锁，阻止其他事务对数据进行修改。

**版本控制 MVCC**：另一种是不用加任何锁，通过一定机制生成一个数据请求时间点的一致性数据快照（Snapshot），并用这个快照来提供一定级别（语句级或事务级）的一致性读取。从用户的角度来看，好像是数据库可以提供同一数据的多个版本，因此，这种技术叫做数据多版本并发控制（MultiVersion Concurrency Control，简称MVCC或MCC），也经常称为多版本数据库。

### 隔离级别

根据使用并发控制程度不同，可用获得不同的事务隔离性，如下图所示。

![database ioslation](../img/database_ioslation.png)
