# 指令集架构

- [指令集架构](#指令集架构)
  - [指令系统发展历史](#指令系统发展历史)
    - [指令内容](#指令内容)
    - [存储管理](#存储管理)
    - [运行级别](#运行级别)
  - [指令系统组成](#指令系统组成)
  - [特权指令系统](#特权指令系统)
  - [参考](#参考)

指令集架构（Instruction Set Architecture）是计算机体系结构中与程序设计有关的部分。它包含了基本数据类型、指令集、寄存器模式、寻址模式、中断集、异常处理以及外部I/O等。

软件以指令形式运行在CPU硬件上，而指令系统介于软件和硬件之间，是软硬件交互的界面，有着非常关键的作用。软硬件本身的更新迭代速度很快，而指令系统则可以保持较长时间的稳定。有了稳定不变的指令系统界面，软件与硬件得到有效的隔离，并行发展。遵循同一指令系统的硬件可以运行为该指令系统设计的各种软件，比如X86计算机既可运行最新软件，也可运行30年前的软件；反之，为一个指令系统设计的软件可以运行在兼容这一指令系统的不同的硬件实现上，例如同样的操作系统和应用软件在AMD与Intel的CPU上都可以运行。

## 指令系统发展历史

指令系统的发展经历了从简单到复杂，再从复杂到简单的演变过程。现代指令系统在指令内容、存储管理和运行级别控制等方面都产生了一系列变化。

### 指令内容

依据指令长度的不同，指令系统可分为复杂指令系统（Complex Instruction Set Computer，简称CISC）、精简指令系统（Reduced Instruction Set Computer，简称RISC）和超长指令字（Very Long InstructionWord，简称VLIW）指令集三种。C

**复杂指令集架构**：

复杂指令集计算机（Complex Instruction Set Computer，CISC）是一种微处理器指令集架构。一条指令可以包含若干低端操作，即若干操作集于单一指令中。复杂指令集的特点是指令数目多而复杂，每条指令字长并不相等，电脑必须加以判读，并为此付出了性能的代价。基于CISC架构的处理器有x86、x64家族等。

**精简指令集架构**：

精简指令集计算机（Reduced Instruction Set Computer，RISC）的特点是指令数目少，每条指令都采用标准字长、执行时间短、中央处理器的实现细节对于机器级程序是可见的等等。RISC设计的根本原则——针对流水线化的处理器优化——没有改变。

常见的RISC架构有MIPS和ARM等。其中，前者是大学课程的重要教学材料，而后者则在嵌入式处理器中非常流行，占超过90%的市场份额。

### 存储管理

存储管理的演变经历了连续实地址、段式、页式虚拟存储等阶段。

连续实地址的管理方式是最早期也是最朴素的方式，各程序所需的内存空间必须连续存放并保证不与其他程序产生冲突。这种方式不但会带来大量的内存碎片，而且难以管理多个程序的空间分配。

段式存储管理将内存分为多个段和节，地址组织为相对于段地址的偏移。段式存储主要应用于早期处理器中，Burroughs 公司的 B5000 是最早使用段式存储的计算机之一。Intel 从 8086 处理器开始使用段式存储管理，在80286之后兼容段页式，但在最新的X86‑64位架构中放弃了对段式管理的支持。

页式虚拟存储管理将各进程的虚拟内存空间划分成若干长度相同的页，将虚拟地址和物理地址的对应关系组织为页表，并通过硬件来实现快速的地址转换。现代通用处理器的存储管理单元都基于页式虚拟管理，并通过 TLB 进行地址转换加速。

页式虚拟存储可使各进程运行在各自独立的虚拟地址空间中，并提供内存映射、公平的物理内存分配和共享虚拟内存等功能，是计算机系统发展过程中具有里程碑意义的一项技术。

### 运行级别

作为软件指令的执行者，处理器中有各种级别的资源，比如通用寄存器、控制寄存器等。为了对软件所能访问的资源加以限制，计算机引入了运行级别的概念。运行级别经历了无管理、增加保护模式、增加调试模式、增加虚拟化支持等阶段。

早期的处理器和当今的嵌入式单片机中不包含运行级别控制，所有程序都可控制所有资源。无管理的方式在安全方面毫无保障，软件必须小心设计，确保不会相互干扰。这通常只在规模有限、封闭可控的系统如微控制器（Micro Control Unit，简称 MCU）中使用。

现代操作系统（如 Linux）包含保护模式，将程序分为两个权限等级：用户态和核心态。核心态具有最高权限，可以执行所有指令、访问任意空间。在用户态下，程序只能访问受限的内存空间，不允许访问外围设备。用户态程序需要使用外围设备时，通过系统调用提出申请，由操作系统在核心态下完成访问。保护模式需要硬件支持，如 X86 指令系统中定义了 Ring0～Ring3四个权限等级，MIPS 指令系统中定义了 user、supervisor 和 kernel 三个权限等级。

## 指令系统组成

指令系统由若干条指令及其操作对象组成。每条指令都是对一个操作的描述，主要包括操作码和操作数。操作码规定指令功能，例如加减法；操作数指示操作对象，包含数据类型、访存地址、寻址方式等内容的定义。

不同指令系统的特权态部分差别较大，但就其机制而言，可以分为以下几类：

- 运行模式定义及其转换
- 虚拟存储管理
- 异常与中断处理
- 控制状态寄存器

## 特权指令系统

在计算机系统层次结构中，应用层1在操作系统层之上，只能看到和使用指令系统的一个子集，即指令系统的用户态部分。每个应用程序都有自己的寄存器、内存空间以及可执行的指令。现代计算机的指令系统在用户态子集之外还定义了操作系统核心专用的特权态部分，我们称之为特权指令系统。

## 参考

- [wiki - Instruction Set Architecture](https://en.wikipedia.org/wiki/Instruction_set_architecture)
- [ISA vs Machine Language](https://www.cise.ufl.edu/~mssz/CompOrg/CDA-lang.html)
- [x86 vs x64](https://www.seeedstudio.com/blog/2020/02/24/what-is-x86-architecture-and-its-difference-between-x64/)
