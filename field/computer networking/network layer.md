# 网络层

- [网络层](#网络层)
  - [IP](#ip)
    - [IP地址](#ip地址)
      - [IP地址分类](#ip地址分类)
      - [特殊的IP地址：广播、组播](#特殊的ip地址广播组播)
      - [动态IP地址分配：DHCP](#动态ip地址分配dhcp)
      - [缓解IP地址不足：NAT](#缓解ip地址不足nat)
    - [IPv6](#ipv6)
    - [IP包的分片和重组](#ip包的分片和重组)
    - [IP包的路由和寻址](#ip包的路由和寻址)
  - [ARP](#arp)
  - [ICMP](#icmp)
    - [Ping](#ping)
    - [Traceroute](#traceroute)

网络层是整个互联网的核心，因此其设计者在设计之初就应当让网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。也就是说，网络层所传出的数据包可能出错、丢失、重复和失序。这也同样使得网络中的路由器可以设计的比较简单，并且价格低廉。

## IP

网际协议(Internet Protocol, IP)是TCP/IP体系中最重要的协议之一，与其一同使用的还有三个协议：

- 地址解析协议ARP(Address Resolution Protocol)
- 网际控制报文协议ICMP(Internet Control Message Protocol)
- 网际组管理协议IGMP(Internet Group Management Protocol)

IP协议将全世界数以万计的结构互异、大小不同的网络都互联了起来，使得在网络层看起来好像是一个统一的网络，也就是所谓的“虚拟互连网络”。这使得对于上层应用来说，当两个不同物理网络的主机进行通信时，就好像在单个网络上一样，它们互相看不见各网络实现细节。

![网络结构](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/8d779ab7-ffcc-47c6-90ec-ede8260b2368.png)

### IP地址

IP地址是一种逻辑地址，仅供网络层和以上各层使用；而物理地址，也被称为硬件地址和MAC地址(Media Access Control, MAC)，是数据链路层和物理层使用的地址。二者的关系有些类似护照和车票。前者在整个旅途中始终不变，而后者根据每段路程选择的交通工具不同会有变化。换句话说，在网络通信中，源IP地址和目标IP地址一般不会变化（除使用了NAT技术之外），而MAC地址则会不断变化。这也恰好对应了计算机网络模型中每层的作用。即，网络层用于实现主机之间的通信，而链路层则用于实现具体每段链路之间的通信。

#### IP地址分类

IP地址的编址方式经历了三个历史阶段，分别是是分类编址、子网划分和无分类编址。

**分类编址**：

其中，采用分类编址的IP地址由网络号和主机号两部分组成。不同分类具有不同的网络号长度，但同一分类的IP地址中的网络号长度是固定的。

![分类的IP地址](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/cbf50eb8-22b4-4528-a2e7-d187143d57f7.png)

**子网划分**：

通过在主机号字段中拿一部分作为子网号，把两级IP地址划分为三级IP地址，就是子网划分。值得注意的是，要使用子网必须配置子网掩码。一个B类地址的默认子网掩码为255.255.0.0，如果B类地址的子网占两个比特，那么子网掩码为11111111 11111111 11000000 00000000，也就是 255.255.192.0。此外，子网划分仅仅是针对局域网内部的计算机通信使用的，外部网络是看不到子网的存在的。

**无分类编址**：

无类别域间路由(Classless Inter-Domain Routing，CIDR)消除了传统A类、B类和C类地址以及划分子网的概念，使用网络前缀和主机号来对IP地址进行编码，网络前缀的长度可以根据需要变化。CIDR的记法上采用在IP地址后面加上网络前缀长度的方法，例如：128.14.35.7/20表示前20位为网络前缀。CIDR的地址掩码可以继续称为子网掩码，子网掩码首1长度为网络前缀的长度。

CIDR中的专用地址段指的是非公用的IP地址段，主要用于内部网络的私有地址分配。它包括三个专用地址块：

- 10.0.0.0 \~ 10.255.255.255
- 172.16.0.0 \~ 172.31.255.255
- 192.168.0.0 \~ 192.168.255.255

#### 特殊的IP地址：广播、组播

广播(Broadcast)是一种网络通信方式，用于将数据包发送给局域网中的所有设备，以便多个设备都能接收到相同的信息。在IP协议中，计算机可将目标地址设置为广播地址来实现广播，进而达成群发消息、网络发现和配置等目的。

一般来说，广播可分为本地广播和直接广播两种。其中，在本网络内广播的叫做本地广播。例如网络地址为 192.168.0.0/24的情况下，广播地址是192.168.0.255 。因为这个广播地址的IP包会被路由器屏蔽，所以不会到达192.168.0.0/24以外的其他链路上。而在不同网络之间的广播叫做直接广播。例如网络地址为192.168.0.0/24的主机向192.168.1.255/24的目标地址发送IP包。收到这个包的路由器，将数据转发给192.168.1.0/24，从而使得所有192.168.1.1~192.168.1.254的主机都能收到这个包（由于直接广播有一定的安全问题，多数情况下会在路由器上设置为不转发。） 。

此外，组播(Multicast)也同样是一种网络通信方式。它能够将一个数据包同时发送给多个属于同一个特定组的设备。正如前文中分类地址中所提到，D类IP地址就是专用来标识组播地址的。

除了广播地址之外，网络地址(Network Address)也是一个特殊的IP地址。它用于标识整个网络的起始地址，且通常是网络的第一个可用地址，即IP地址中的主机部分全部为0。回环地址(Loopback Address)同样是一个特殊的IP地址，用于将数据包发送给本地设备，而不经过网络传输。它通常是127.0.0.1，在IPv4网络中用于本地主机的回环测试和自我通信。

#### 动态IP地址分配：DHCP

动态主机设置协议(Dynamic Host Configuration Protocol, DHCP)是一个用于IP网络的网络协议，位于OSI模型的应用层，使用UDP协议工作。指的一提的是，DHCP客户端进程监听的是68端口号，而DHCP服务端进程监听的是67端口号。

**DHCP分配IP地址流程**：

DHCP的主要作用就是为私有网络中主机自动分配IP地址。假设有一个新启动需要加入网络的计算机，那么它使用DHCP协议分配到一个IP地址并获取其他相关信息的流程如下：

- 客户端首先发起DHCP发现报文(DHCP DISCOVER)的IP数据报。由于客户端没有IP地址，也不知道DHCP服务器的地址，所以使用的是UDP广播通信。该数据报的目标地址是255.255.255.255:67，而源地址则为0.0.0.0:68。接着，DHCP客户端将该IP数据报传递给链路层，链路层然后将帧广播到所有的网络中设备。
- 当DHCP服务器收到 DHCP 发现报文时，用DHCP提供报文(DHCP OFFER)向客户端做出响应。该报文仍然使用广播地址255.255.255.255作为目标地址，因为此时DHCP客户端并没有一个IP地址。此外，该数据报中信息包括：服务器提供可租约的IP地址、子网掩码、默认网关、DNS服务器以及IP地址租用时间。
- 客户端收到一个或多个服务器的DHCP提供报文后，从中选择一个服务器，并向选中的服务器发送DHCP请求报文(DHCP REQUEST)进行响应，回显配置的参数。
- 最后，服务端用DHCP ACK报文对DHCP请求报文进行响应，应答所要求的参数。一旦客户端收到DHCP ACK后，交互便完成了，并且客户端能够在租用期内使用DHCP服务器分配的IP地址。

**DHCP续租IP地址流程**：

如果租约的DHCP IP地址快期后，客户端则会再次向服务器发送DHCP请求报文：

- 服务器如果同意继续租用，则用DHCP ACK报文进行应答，客户端就会延长租期。
- 服务器如果不同意继续租用，则用DHCP NACK报文，客户端就要停止使用租约的IP地址。

**DHCP中继代理**：

可以发现，DHCP交互中全程都是使用UDP广播通信。但当DHCP服务器和客户端不是在同一个局域网内，路由器又不会转发广播包，那么此时就需要引入DHCP中继代理。有了中继代理之后会，DHCP客户端会向DHCP中继代理发送DHCP请求包，而DHCP中继代理在收到这个广播包以后，再以单播的形式发给DHCP服务器。而服务器端收到该包以后再向DHCP中继代理返回应答，并由DHCP中继代理将此包广播给DHCP客户端 。

#### 缓解IP地址不足：NAT

在IPv4协议中，IP地址数量不足是一个大问题，而网络地址转换技术(Network Address Translation, NAT)就是解决该问题的主要手段。它通过重用同一个公网IP地址，将私有网络中的多个主机映射到这个公网IP上，从而实现节约公网IP地址的目的。换句话说，NAT保证了私有网络中的专用IP和公网主机的通信。

**NAT的原理**：

假设有两个客户端192.168.1.10和192.168.1.11同时与服务器183.232.231.172进行通信，并且这两个客户端的本地端口都是1025。使用NAT技术进行转换，将这两个私有IP地址都转换为公有地址 120.229.175.121，但是以不同的端口号作为区分。换句话说，NAT重用公网IP以端口号进行区分（即网络地址与端口转换技术，NAPT），并将转换关系保存在映射表中以保证TCP之类的持续通信。

**NAT的缺陷**：

由于NAT/NAPT依赖于自己的转换表，因此会有以下的问题：

- 外部无法主动与NAT内部服务器建立连接，因为转换表没有转换记录。
- 转换表的生成与转换操作都会产生性能开销。
- 通信过程中，如果NAT路由器重启了，所有的TCP连接都将被重置。

而解决这些问题主要有两种手段：

- 改用IPv6，因为IPv6可用范围非常大，以至于每台设备都可以配置一个公有IP地址，就不搞那么多花里胡哨的地址转换了。
- NAT穿透技术。

**NAT vs DHCP**：

从这里，我们也可看出NAT和DHCP的区别。其中，前者用于私有IP和重用的公网IP间的翻译，而后者则用于给私有网络中主机分配IP。二者一起解决了IP地址不足的问题。

### IPv6

虽然目前的NAT及CIDR等技术可延缓网络位置匮乏之现象，但为求解决根本问题，IPv6被提出了。和IPv4相比，它使用128位的编码长度，且和前者不兼容。这可能也是目前IPv6普及较慢的原因。除了更长的地址编码空间之外，IPv6还有很多亮点，包括：

- IPv6可自动配置，即使没有DHCP服务器也可以实现自动分配IP地址，真是便捷到即插即用啊。
- IPv6包头包首部长度采用固定的值40字节，去掉了包头校验和，简化了首部结构，减轻了路由器负荷，大大提高了传输的性能。
- IPv6有应对伪造IP地址的网络安全功能以及防止线路窃听的功能，大大提升了安全性。

**首部差异**：

关于IPv4首部与IPv6首部的差异具体如下图所示，二者主要区别包括：

- 取消了首部校验和字段。因为在数据链路层和传输层都会校验，因此IPv6直接取消了IP的校验。
- 取消了分片/重新组装相关字段。分片与重组是耗时的过程，IPv6不允许在中间路由器进行分片与重组，这种操作只能在源与目标主机，这将大大提高了路由器转发的速度。
- 取消选项字段。选项字段不再是标准IP首部的一部分了，但它并没有消失，而是可能出现在 IPv6首部中的「下一个首部」指出的位置上。删除该选项字段使的IPv6的首部成为固定长度的40字节。

![IPv4 vs IPv6](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/31.jpg)

### IP包的分片和重组

每种数据链路的最大传输单元(Maximum Transmission Unit, MTU)都是不相同的，如FDDI数据链路的MTU为4352、以太网的MTU是1500字节等。那么当IP数据包大小大于MTU时，IP数据包就会被分片。经过分片之后的IP数据报在被重组的时候，只能由目标主机进行，路由器是不会进行重组的。而这些分片传输中，一旦某个分片丢失则会造成整个IP数据报作废。因此，TCP引入了最大分段大小(Maximum Segement Size, MSS)来避免超过MTU从而避免IP数据包分片。

### IP包的路由和寻址

**一个IP包传输的例子**：

假设有一台计算机A希望发送IP数据包到另一台计算机B上。那么它会首先检查自己的子网掩码，判断目标地址是否与自己在同一个子网中。

- 如果是，计算机A则使用ARP协议将目标IP地址转换为对应的MAC地址，并将数据包封装成数据帧发送到目标MAC地址。这就完成了该包的传输。
- 反之，计算机A则会将该包发送到默认网关即路由器中。然后，路由器将负责根据自己维护的路由表进行路由跳转，将数据包转发到正确的下一跳路由器或目标IP地址。找到到达目标IP地址所需的下一跳路由器的IP地址。
- 紧接着，使用ARP协议获取下一跳路由器的MAC地址，并将数据包封装成数据帧发送到目标MAC地址。下一跳路由器接收到数据帧后，会解析帧中的IP数据包，根据目标IP地址继续转发。这个过程会一直重复，直到数据包到达目标IP地址所在的网络。

**路由器的转发**：

路由器工作在网络层（3层）， 交换机工作在数据链路层。路由器作用就是路由，路由器对数据包选择最佳路径！

## ARP

地址解析协议(Address Resolution Protocol, ARP)是一个通过解析网络层地址来找寻数据链路层地址的网络传输协议，即通过IP地址寻找MAC地址。假设当计算机A需要与计算机B进行通信，但计算机A只知道计算机B的IP地址，不知道其MAC地址。那么计算机A通过ARP协议获取计算机B的MAC地址流程如下：

- 首先，ARP协议的基础是每个主机和路由器都有一个ARP高速缓存，它包含本局域网上的各主机和路由器的IP地址到MAC地址的映射表。
- 因此，当计算机A想要查询计算机B的MAC地址时，它会先检查该缓存。当缓存中不存在该IP地址到MAC地址的映射时，计算机A则会发送ARP请求，即：向局域网内广播一个特殊的帧，其中包含了自己的IP地址和MAC地址，以及目标主机的IP地址。该帧的目标MAC地址为广播地址FF-FF-FF-FF-FF-FF，表示所有设备都要接收该帧。
- 当局域网内的计算机收到该请求后，会根据其中的目的IP地址判断是否为自己。如果不是自己，则丢弃该帧，并且将发送者的IP地址和MAC地址加入自己的ARP缓存表中。如果是自己，则回复一个ARP响应，向发送者单播一个特殊的帧，其中包含了自己的IP地址和MAC地址，以及发送者的IP地址。该帧的目标MAC地址为发送者的MAC地址。
- 最终，计算机A会收到该响应，并向其ARP缓存中写入主机B的IP地址到MAC地址的映射。

## ICMP

互联网控制消息协议(Internet Control Message Protocol, ICMP)是互联网协议族的核心协议之一。它用于网际协议中发送控制消息，提供可能发生在通信环境中的各种问题反馈，从而更有效地转发IP数据报并且提高数据报交付成功率。每个ICMP消息都是直接封装在一个IP数据包中进行传输，因此和UDP一样ICMP也是不可靠的。尽管它依赖IP协议传输，但它却不属于高层协议。

ICMP报文大致可以分为两大类：一类是用于诊断的查询消息，也就是查询报文类型；另一类是通知出错原因的错误消息，也就是差错报文类型。其具体报文类型如下图所示。

![ICMP报文](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/41.jpg)

### Ping

Ping是ICMP的一个重要应用，主要用来测试两台主机之间的连通性。它的原理是通过向目的主机发送ICMP Echo请求报文，目的主机收到之后会发送Echo回答报文。Ping会根据时间和成功响应的次数估算出数据包往返时间以及丢包率。

### Traceroute

Traceroute是ICMP的另一个应用，用来跟踪一个分组从源点到终点的路径。它通过发送一系列的ICMP Echo请求报文，利用报文的TTL(Time To Live)字段和获取报文的源IP地址来推断数据包的路径。其具体流程如下：

- 发送第一个ICMP回显请求报文：Traceroute首先向目标主机发送一个ICMP回显请求报文，其中设置了TTL的初始值（通常为1）。TTL表示数据包在网络中可以经过的最大跳数。
- 数据包发送到第一个路由器：ICMP回显请求报文首先到达第一个路由器，因为TTL的初始值是1，所以报文的TTL字段减1，变为0。当路由器接收到TTL为0的报文时，它会丢弃报文，并发送一个ICMP超时报文给源主机。
- 获取第一个路由器的IP地址：当源主机收到来自第一个路由器的ICMP超时报文时，它可以获取到第一个路由器的IP地址。通过记录ICMP回显请求报文的源IP地址和ICMP超时报文的目标IP地址，就- 可以确定数据包经过了第一个路由器。
- 递增TTL值并重复步骤2和3：Traceroute递增TTL的值，再次发送一个ICMP回显请求报文。这次TTL的值为2，然后3，然后4，以此类推。每次发送报文后，都会记录下经过的路由器的IP地址，直到报文到达目标主机。
- 结束条件：Traceroute会持续发送ICMP回显请求报文，直到达到某个结束条件，比如到达目标主机、达到预设的最大跳数或者发送的报文数量超过了预设的次数。
