# 网络层

- [网络层](#网络层)
  - [IP](#ip)
    - [IP地址](#ip地址)
      - [IP地址分类](#ip地址分类)
      - [特殊的IP地址：广播和组播](#特殊的ip地址广播和组播)
      - [缓解IP地址不足：NAT](#缓解ip地址不足nat)
      - [动态IP地址分配：DHCP](#动态ip地址分配dhcp)
    - [IPv6](#ipv6)
    - [IP包的分片和重组](#ip包的分片和重组)
    - [IP包的路由和寻址](#ip包的路由和寻址)
  - [ARP](#arp)
  - [ICMP](#icmp)
    - [Ping](#ping)
    - [Traceroute](#traceroute)

网络层是整个互联网的核心，因此其设计者在设计之初就应当让网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。也就是说，网络层所传出的数据包可能出错、丢失、重复和失序。这也同样使得网络中的路由器可以设计的比较简单，并且价格低廉。

## IP

网际协议(Internet Protocol, IP)是TCP/IP体系中最重要的协议之一，与其一同使用的还有三个协议：

- 地址解析协议ARP(Address Resolution Protocol)
- 网际控制报文协议ICMP(Internet Control Message Protocol)
- 网际组管理协议IGMP(Internet Group Management Protocol)

IP协议将全世界数以万计的结构互异、大小不同的网络都互联了起来，使得在网络层看起来好像是一个统一的网络，也就是所谓的“虚拟互连网络”。这使得对于上层应用来说，当两个不同物理网络的主机进行通信时，就好像在单个网络上一样，它们互相看不见各网络实现细节。

![网络结构](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/8d779ab7-ffcc-47c6-90ec-ede8260b2368.png)

### IP地址

IP地址是一种逻辑地址，仅供网络层和以上各层使用；而物理地址，也被称为硬件地址和MAC地址(Media Access Control, MAC)，是数据链路层和物理层使用的地址。二者的关系有些类似护照和车票。前者在整个旅途中始终不变，而后者根据每段路程选择的交通工具不同会有变化。换句话说，在网络通信中，源IP地址和目标IP地址一般不会变化（除使用了NAT技术之外），而MAC地址则会不断变化。这也恰好对应了计算机网络模型中每层的作用。即，网络层用于实现主机之间的通信，而链路层则用于实现具体每段链路之间的通信。

#### IP地址分类

IP地址的编址方式经历了三个历史阶段，分别是是分类编址、子网划分和无分类编址。

**分类编址**：

其中，采用分类编址的IP地址由网络号和主机号两部分组成。不同分类具有不同的网络号长度，但同一分类的IP地址中的网络号长度是固定的。

![分类的IP地址](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/cbf50eb8-22b4-4528-a2e7-d187143d57f7.png)

**子网划分**：

通过在主机号字段中拿一部分作为子网号，把两级IP地址划分为三级IP地址，就是子网划分。值得注意的是，要使用子网必须配置子网掩码。一个B类地址的默认子网掩码为255.255.0.0，如果B类地址的子网占两个比特，那么子网掩码为11111111 11111111 11000000 00000000，也就是 255.255.192.0。此外，子网划分仅仅是针对局域网内部的计算机通信使用的，外部网络是看不到子网的存在的。

**无分类编址**：

无类别域间路由(Classless Inter-Domain Routing，CIDR)消除了传统A类、B类和C类地址以及划分子网的概念，使用网络前缀和主机号来对IP地址进行编码，网络前缀的长度可以根据需要变化。CIDR的记法上采用在IP地址后面加上网络前缀长度的方法，例如：128.14.35.7/20表示前20位为网络前缀。CIDR的地址掩码可以继续称为子网掩码，子网掩码首1长度为网络前缀的长度。

CIDR中的专用地址段指的是非公用的IP地址段，主要用于内部网络的私有地址分配。它包括三个专用地址块：

- 10.0.0.0 \~ 10.255.255.255
- 172.16.0.0 \~ 172.31.255.255
- 192.168.0.0 \~ 192.168.255.255

#### 特殊的IP地址：广播和组播

在IP地址中，有两个IP是特殊的，分别是主机号全为1和全为0地址。其中，主机号全为1指定某个网络下的所有主机，用于广播；而主机号全为0指定某个网络。其中，前者只能作为目的地址，而后者则只能作为源地址。

![IP地址](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/10.jpg)

#### 缓解IP地址不足：NAT

在IPv4协议中，IP地址数量不足是一个大问题，而网络地址转换技术(Network Address Translation, NAT)就是解决该问题的主要手段。

#### 动态IP地址分配：DHCP

动态主机设置协议(Dynamic Host Configuration Protocol, DHCP)

### IPv6

虽然目前的NAT及CIDR等技术可延缓网络位置匮乏之现象，但为求解决根本问题，IPv6被提出了。和IPv4相比，它使用128位的编码长度，且和前者不兼容。这可能也是目前IPv6普及较慢的原因。除了更长的地址编码空间之外，IPv6还有很多亮点，包括：

- IPv6可自动配置，即使没有DHCP服务器也可以实现自动分配IP地址，真是便捷到即插即用啊。
- IPv6包头包首部长度采用固定的值40字节，去掉了包头校验和，简化了首部结构，减轻了路由器负荷，大大提高了传输的性能。
- IPv6有应对伪造IP地址的网络安全功能以及防止线路窃听的功能，大大提升了安全性。

**首部差异**：

关于IPv4首部与IPv6首部的差异具体如下图所示，二者主要区别包括：

- 取消了首部校验和字段。因为在数据链路层和传输层都会校验，因此IPv6直接取消了IP的校验。
- 取消了分片/重新组装相关字段。分片与重组是耗时的过程，IPv6不允许在中间路由器进行分片与重组，这种操作只能在源与目标主机，这将大大提高了路由器转发的速度。
- 取消选项字段。选项字段不再是标准IP首部的一部分了，但它并没有消失，而是可能出现在 IPv6首部中的「下一个首部」指出的位置上。删除该选项字段使的IPv6的首部成为固定长度的40字节。

![IPv4 vs IPv6](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/31.jpg)

### IP包的分片和重组

每种数据链路的最大传输单元(Maximum Transmission Unit, MTU)都是不相同的，如FDDI数据链路的MTU为4352、以太网的MTU是1500字节等。那么当IP数据包大小大于MTU时，IP数据包就会被分片。经过分片之后的IP数据报在被重组的时候，只能由目标主机进行，路由器是不会进行重组的。而这些分片传输中，一旦某个分片丢失则会造成整个IP数据报作废。因此，TCP引入了最大分段大小(Maximum Segement Size, MSS)来避免超过MTU从而避免IP数据包分片。

### IP包的路由和寻址

**一个IP包传输的例子**：

假设有一台计算机A希望发送IP数据包到另一台计算机B上。那么它会首先检查自己的子网掩码，判断目标地址是否与自己在同一个子网中。

- 如果是，计算机A则使用ARP协议将目标IP地址转换为对应的MAC地址，并将数据包封装成数据帧发送到目标MAC地址。这就完成了该包的传输。
- 反之，计算机A则会将该包发送到默认网关即路由器中。然后，路由器将负责根据自己维护的路由表进行路由跳转，将数据包转发到正确的下一跳路由器或目标IP地址。找到到达目标IP地址所需的下一跳路由器的IP地址。
- 紧接着，使用ARP协议获取下一跳路由器的MAC地址，并将数据包封装成数据帧发送到目标MAC地址。下一跳路由器接收到数据帧后，会解析帧中的IP数据包，根据目标IP地址继续转发。这个过程会一直重复，直到数据包到达目标IP地址所在的网络。

**路由器的转发**：

路由器工作在网络层（3层）， 交换机工作在数据链路层。路由器作用就是路由，路由器对数据包选择最佳路径！

## ARP

地址解析协议(Address Resolution Protocol, ARP)是一个通过解析网络层地址来找寻数据链路层地址的网络传输协议，即通过IP地址寻找MAC地址。假设当计算机A需要与计算机B进行通信，但计算机A只知道计算机B的IP地址，不知道其MAC地址。那么计算机A通过ARP协议获取计算机B的MAC地址流程如下：

- 首先，ARP协议的基础是每个主机和路由器都有一个ARP高速缓存，它包含本局域网上的各主机和路由器的IP地址到MAC地址的映射表。
- 因此，当计算机A想要查询计算机B的MAC地址时，它会先检查该缓存。当缓存中不存在该IP地址到MAC地址的映射时，计算机A则会发送ARP请求，即：向局域网内广播一个特殊的帧，其中包含了自己的IP地址和MAC地址，以及目标主机的IP地址。该帧的目标MAC地址为广播地址FF-FF-FF-FF-FF-FF，表示所有设备都要接收该帧。
- 当局域网内的计算机收到该请求后，会根据其中的目的IP地址判断是否为自己。如果不是自己，则丢弃该帧，并且将发送者的IP地址和MAC地址加入自己的ARP缓存表中。如果是自己，则回复一个ARP响应，向发送者单播一个特殊的帧，其中包含了自己的IP地址和MAC地址，以及发送者的IP地址。该帧的目标MAC地址为发送者的MAC地址。
- 最终，计算机A会收到该响应，并向其ARP缓存中写入主机B的IP地址到MAC地址的映射。

## ICMP

互联网控制消息协议(Internet Control Message Protocol, ICMP)是互联网协议族的核心协议之一。它用于网际协议中发送控制消息，提供可能发生在通信环境中的各种问题反馈，从而更有效地转发IP数据报并且提高数据报交付成功率。每个ICMP消息都是直接封装在一个IP数据包中进行传输，因此和UDP一样ICMP也是不可靠的。尽管它依赖IP协议传输，但它却不属于高层协议。

### Ping

Ping是ICMP的一个重要应用，主要用来测试两台主机之间的连通性。它的原理是通过向目的主机发送ICMP Echo请求报文，目的主机收到之后会发送Echo回答报文。Ping会根据时间和成功响应的次数估算出数据包往返时间以及丢包率。

### Traceroute

Traceroute是ICMP的另一个应用，用来跟踪一个分组从源点到终点的路径。它通过发送一系列的ICMP Echo请求报文，利用报文的TTL(Time To Live)字段和获取报文的源IP地址来推断数据包的路径。其具体流程如下：

- 发送第一个ICMP回显请求报文：Traceroute首先向目标主机发送一个ICMP回显请求报文，其中设置了TTL的初始值（通常为1）。TTL表示数据包在网络中可以经过的最大跳数。
- 数据包发送到第一个路由器：ICMP回显请求报文首先到达第一个路由器，因为TTL的初始值是1，所以报文的TTL字段减1，变为0。当路由器接收到TTL为0的报文时，它会丢弃报文，并发送一个ICMP超时报文给源主机。
- 获取第一个路由器的IP地址：当源主机收到来自第一个路由器的ICMP超时报文时，它可以获取到第一个路由器的IP地址。通过记录ICMP回显请求报文的源IP地址和ICMP超时报文的目标IP地址，就- 可以确定数据包经过了第一个路由器。
- 递增TTL值并重复步骤2和3：Traceroute递增TTL的值，再次发送一个ICMP回显请求报文。这次TTL的值为2，然后3，然后4，以此类推。每次发送报文后，都会记录下经过的路由器的IP地址，直到报文到达目标主机。
- 结束条件：Traceroute会持续发送ICMP回显请求报文，直到达到某个结束条件，比如到达目标主机、达到预设的最大跳数或者发送的报文数量超过了预设的次数。
