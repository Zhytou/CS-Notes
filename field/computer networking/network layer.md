# 网络层

- [网络层](#网络层)
  - [IP](#ip)
    - [IP地址](#ip地址)
      - [IP地址分类](#ip地址分类)
      - [特殊的IP地址](#特殊的ip地址)
      - [缓解IP地址不足](#缓解ip地址不足)
    - [IPv6](#ipv6)
    - [IP包的分片和重组](#ip包的分片和重组)
    - [IP包的路由和寻址](#ip包的路由和寻址)
  - [ARP](#arp)
  - [ICMP](#icmp)
    - [Ping](#ping)
    - [Traceroute](#traceroute)
  - [Other Protocol](#other-protocol)
    - [DHCP](#dhcp)
    - [NAT](#nat)

网络层是整个互联网的核心，因此其设计者在设计之初就应当让网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。也就是说，网络层所传出的数据包可能出错、丢失、重复和失序。这也同样使得网络中的路由器可以设计的比较简单，并且价格低廉。

## IP

网际协议(Internet Protocol, IP)是TCP/IP体系中最重要的协议之一，与其一同使用的还有三个协议：

- 地址解析协议ARP(Address Resolution Protocol)
- 网际控制报文协议ICMP(Internet Control Message Protocol)
- 网际组管理协议IGMP(Internet Group Management Protocol)

IP协议将全世界数以万计的结构互异、大小不同的网络都互联了起来，使得在网络层看起来好像是一个统一的网络，也就是所谓的“虚拟互连网络”。这使得对于上层应用来说，当两个不同物理网络的主机进行通信时，就好像在单个网络上一样，它们互相看不见各网络实现细节。

![网络结构](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/8d779ab7-ffcc-47c6-90ec-ede8260b2368.png)

### IP地址

IP地址是一种逻辑地址，仅供网络层和以上各层使用；而物理地址，也被称为硬件地址和MAC地址(Media Access Control, MAC)，是数据链路层和物理层使用的地址。

#### IP地址分类

IP地址的编址方式经历了三个历史阶段，分别是是分类编址、子网划分和无分类编址。

**分类编址**：

其中，采用分类编址的IP地址由网络号和主机号两部分组成。不同分类具有不同的网络号长度，但同一分类的IP地址中的网络号长度是固定的。

![分类的IP地址](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/cbf50eb8-22b4-4528-a2e7-d187143d57f7.png)

**子网划分**：

通过在主机号字段中拿一部分作为子网号，把两级IP地址划分为三级IP地址，就是子网划分。值得注意的是，要使用子网必须配置子网掩码。一个B类地址的默认子网掩码为255.255.0.0，如果B类地址的子网占两个比特，那么子网掩码为11111111 11111111 11000000 00000000，也就是 255.255.192.0。此外，子网划分仅仅是针对局域网内部的计算机通信使用的，外部网络是看不到子网的存在的。

**无分类编址**：

无类别域间路由(Classless Inter-Domain Routing，CIDR)消除了传统A类、B类和C类地址以及划分子网的概念，使用网络前缀和主机号来对IP地址进行编码，网络前缀的长度可以根据需要变化。CIDR的记法上采用在IP地址后面加上网络前缀长度的方法，例如：128.14.35.7/20表示前20位为网络前缀。CIDR的地址掩码可以继续称为子网掩码，子网掩码首1长度为网络前缀的长度。

CIDR中的专用地址段指的是非公用的IP地址段，主要用于内部网络的私有地址分配。它包括三个专用地址块：

- 10.0.0.0 \~ 10.255.255.255
- 172.16.0.0 \~ 172.31.255.255
- 192.168.0.0 \~ 192.168.255.255

#### 特殊的IP地址

在IP地址中，有两个IP是特殊的，分别是主机号全为1和全为0地址。其中，主机号全为1指定某个网络下的所有主机，用于广播；而主机号全为0指定某个网络。其中，前者只能作为目的地址，而后者则只能作为源地址。

![IP地址](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/10.jpg)

#### 缓解IP地址不足

在IPv4协议中，IP地址数量不足是一个大问题，而网络地址转换技术(Network Address Translation, NAT)就是解决该问题的主要手段。

### IPv6

虽然目前的NAT及CIDR等技术可延缓网络位置匮乏之现象，但为求解决根本问题，IPv6被提出了。和IPv4相比，它使用128位的编码长度，且和前者不兼容。这可能也是目前IPv6普及较慢的原因。除了更长的地址编码空间之外，IPv6还有很多亮点，包括：

- IPv6可自动配置，即使没有DHCP服务器也可以实现自动分配IP地址，真是便捷到即插即用啊。
- IPv6包头包首部长度采用固定的值40字节，去掉了包头校验和，简化了首部结构，减轻了路由器负荷，大大提高了传输的性能。
- IPv6有应对伪造IP地址的网络安全功能以及防止线路窃听的功能，大大提升了安全性。

**首部差异**：

关于IPv4首部与IPv6首部的差异具体如下图所示，二者主要区别包括：

- 取消了首部校验和字段。因为在数据链路层和传输层都会校验，因此IPv6直接取消了IP的校验。
- 取消了分片/重新组装相关字段。分片与重组是耗时的过程，IPv6不允许在中间路由器进行分片与重组，这种操作只能在源与目标主机，这将大大提高了路由器转发的速度。
- 取消选项字段。选项字段不再是标准IP首部的一部分了，但它并没有消失，而是可能出现在 IPv6首部中的「下一个首部」指出的位置上。删除该选项字段使的IPv6的首部成为固定长度的40字节。

![IPv4 vs IPv6](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/31.jpg)

### IP包的分片和重组

每种数据链路的最大传输单元(Maximum Transmission Unit, MTU)都是不相同的，如FDDI数据链路的MTU为4352、以太网的MTU是1500字节等。那么当IP数据包大小大于MTU时，IP数据包就会被分片。经过分片之后的IP数据报在被重组的时候，只能由目标主机进行，路由器是不会进行重组的。而这些分片传输中，一旦某个分片丢失则会造成整个IP数据报作废。因此，TCP引入了最大分段大小(Maximum Segement Size, MSS)来避免超过MTU从而避免IP数据包分片。

### IP包的路由和寻址

**一个IP包传输的例子**：

假设有一台计算机A希望发送IP数据包到另一台计算机B上。那么它会首先检查自己的子网掩码，判断目标地址是否与自己在同一个子网中。

- 如果是，计算机A则使用ARP协议将目标IP地址转换为对应的MAC地址，并将数据包封装成数据帧发送到目标MAC地址。这就完成了该包的传输。
- 反之，计算机A则会将该包发送到默认网关即路由器中。然后，路由器将负责根据自己维护的路由表进行路由跳转，将数据包转发到正确的下一跳路由器或目标IP地址。找到到达目标IP地址所需的下一跳路由器的IP地址。
- 紧接着，使用ARP协议获取下一跳路由器的MAC地址，并将数据包封装成数据帧发送到目标MAC地址。下一跳路由器接收到数据帧后，会解析帧中的IP数据包，根据目标IP地址继续转发。这个过程会一直重复，直到数据包到达目标IP地址所在的网络。

**路由器的转发**：

路由器工作在网络层（3层）， 交换机工作在数据链路层。路由器作用就是路由，路由器对数据包选择最佳路径！

网络层实现主机之间的通信，而链路层实现具体每段链路之间的通信。因此在通信过程中，IP数据报的源地址和目的地址始终不变，而MAC地址随着链路的改变而改变。

## ARP

地址解析协议(Address Resolution Protocol, ARP)是一个通过解析网络层地址来找寻数据链路层地址的网络传输协议，即通过IP地址寻找MAC地址。假设当计算机A需要与计算机B进行通信，但计算机A只知道计算机B的IP地址，不知道其MAC地址。那么计算机A通过ARP协议获取计算机B的MAC地址流程如下：

- 首先，ARP协议的基础是每个主机和路由器都有一个ARP高速缓存，它包含本局域网上的各主机和路由器的IP地址到MAC地址的映射表。
- 因此，当计算机A想要查询计算机B的MAC地址时，它会先检查该缓存。当缓存中不存在该IP地址到MAC地址的映射时，计算机A会通过广播的方式向局域网内所有主机发送ARP地址查询请求。
- 当计算机B收到该请求后会发送ARP响应，向计算机A告知其MAC地址，随后计算机A向其ARP缓存中写入主机B的IP地址到MAC地址的映射。

## ICMP

ICMP 是为了更有效地转发 IP 数据报和提高交付成功的机会。它封装在 IP 数据报中，但是不属于高层协议。

![ICMP数据报格式](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/e3124763-f75e-46c3-ba82-341e6c98d862.jpg)

ICMP 报文分为差错报告报文和询问报文。

### Ping

Ping 是 ICMP 的一个重要应用，主要用来测试两台主机之间的连通性。

Ping 的原理是通过向目的主机发送 ICMP Echo 请求报文，目的主机收到之后会发送 Echo 回答报文。Ping 会根据时间和成功响应的次数估算出数据包往返时间以及丢包率。

### Traceroute

Traceroute 是 ICMP 的另一个应用，用来跟踪一个分组从源点到终点的路径。

Traceroute 发送的 IP 数据报封装的是无法交付的 UDP 用户数据报，并由目的主机发送终点不可达差错报告报文。

- 源主机向目的主机发送一连串的 IP 数据报。第一个数据报 P1 的生存时间 TTL 设置为 1，当 P1 到达路径上的第一个路由器 R1 时，R1 收下它并把 TTL 减 1，此时 TTL 等于 0，R1 就把 P1 丢弃，并向源主机发送一个 ICMP 时间超过差错报告报文；
- 源主机接着发送第二个数据报 P2，并把 TTL 设置为 2。P2 先到达 R1，R1 收下后把 TTL 减 1 再转发给 R2，R2 收下后也把 TTL 减 1，由于此时 TTL 等于 0，R2 就丢弃 P2，并向源主机发送一个 ICMP 时间超过差错报文。
- 不断执行这样的步骤，直到最后一个数据报刚刚到达目的主机，主机不转发数据报，也不把 TTL 值减 1。但是因为数据报封装的是无法交付的 UDP，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文。
- 之后源主机知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间。

## Other Protocol

### DHCP

### NAT
